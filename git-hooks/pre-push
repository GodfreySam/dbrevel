#!/bin/bash
# Git pre-push hook to run Python linting and type checking
# This runs black, ruff, and mypy before allowing push to GitHub

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-push checks...${NC}"

# Get the project root (parent of .git directory)
PROJECT_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
BACKEND_DIR="${PROJECT_ROOT}/backend"

# Check if backend directory exists
if [ ! -d "$BACKEND_DIR" ]; then
    echo -e "${RED}Error: backend directory not found at ${BACKEND_DIR}${NC}"
    exit 1
fi

cd "$BACKEND_DIR"

# Check if we're in a virtual environment or if tools are available
if ! command -v black &> /dev/null; then
    echo -e "${RED}Error: black not found. Please install dependencies: pip install -r requirements.txt${NC}"
    exit 1
fi

if ! command -v ruff &> /dev/null; then
    echo -e "${RED}Error: ruff not found. Please install dependencies: pip install -r requirements.txt${NC}"
    exit 1
fi

if ! command -v mypy &> /dev/null; then
    echo -e "${RED}Error: mypy not found. Please install dependencies: pip install -r requirements.txt${NC}"
    exit 1
fi

# Run checks on all Python files in backend/app
# (We check all files, not just changed ones, to catch issues early)

echo -e "${YELLOW}Checking Python files in backend/app...${NC}"

# Run black check
echo -e "\n${YELLOW}Running black (formatting check)...${NC}"
if ! black --check app/ 2>&1; then
    echo -e "${RED}❌ Black check failed. Run 'black app/' to fix formatting.${NC}"
    exit 1
fi
echo -e "${GREEN}✓ Black check passed${NC}"

# Run ruff check
echo -e "\n${YELLOW}Running ruff (linting)...${NC}"
if ! ruff check app/ 2>&1; then
    echo -e "${RED}❌ Ruff check failed. Run 'ruff check app/' to see issues.${NC}"
    exit 1
fi
echo -e "${GREEN}✓ Ruff check passed${NC}"

# Run mypy check
echo -e "\n${YELLOW}Running mypy (type checking)...${NC}"
# Filter out notes and only show errors
if ! mypy app/ --ignore-missing-imports 2>&1 | grep -v "note:" | grep -E "(error|Error|Failed)" || [ ${PIPESTATUS[0]} -eq 0 ]; then
    # Check actual exit code
    MYPY_EXIT=${PIPESTATUS[0]}
    if [ $MYPY_EXIT -ne 0 ]; then
        echo -e "${RED}❌ Mypy check failed.${NC}"
        exit 1
    fi
fi
echo -e "${GREEN}✓ Mypy check passed${NC}"

echo -e "\n${GREEN}✅ All pre-push checks passed!${NC}"
exit 0
